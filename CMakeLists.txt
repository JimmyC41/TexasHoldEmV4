cmake_minimum_required(VERSION 3.16)
set(CMAKE_FIND_PACKAGE_PREFER_CONFIG TRUE)
project(TexasHoldEm VERSION 1.0 LANGUAGES CXX)

# Set C++ standard
set(CMAKE_CXX_STANDARD 23)
set(CMAKE_CXX_STANDARD_REQUIRED ON)

# Include Conan toolchain (ensure this is generated by Conan)
include(${CMAKE_BINARY_DIR}/generators/conan_toolchain.cmake)

# Find required packages
find_package(Boost REQUIRED COMPONENTS random)
find_package(GTest REQUIRED)
find_package(Protobuf REQUIRED)
find_package(gRPC REQUIRED)
find_package(Threads REQUIRED)

# Include directories
include_directories(${PROJECT_SOURCE_DIR}/include)
include_directories(${CMAKE_CURRENT_BINARY_DIR}) # For generated headers

# Proto files
set(PROTO_FILES
    proto/texas_holdem.proto
)

# Verify that the Protobuf compiler is found
if(NOT Protobuf_PROTOC_EXECUTABLE)
    message(FATAL_ERROR "Protobuf compiler (protoc) not found")
endif()

# Get the location of the gRPC C++ plugin
get_target_property(GRPC_CPP_PLUGIN_LOCATION gRPC::grpc_cpp_plugin IMPORTED_LOCATION)
if(NOT GRPC_CPP_PLUGIN_LOCATION)
    message(FATAL_ERROR "gRPC C++ plugin not found")
endif()

# Generate Protobuf sources
protobuf_generate_cpp(PROTO_SRC PROTO_HDR ${PROTO_FILES})

# Generate gRPC sources using a custom command
add_custom_command(
    OUTPUT ${CMAKE_CURRENT_BINARY_DIR}/texas_holdem.grpc.pb.cc
           ${CMAKE_CURRENT_BINARY_DIR}/texas_holdem.grpc.pb.h
    COMMAND ${Protobuf_PROTOC_EXECUTABLE}
    ARGS --grpc_out=${CMAKE_CURRENT_BINARY_DIR}
         --cpp_out=${CMAKE_CURRENT_BINARY_DIR}
         -I ${CMAKE_CURRENT_SOURCE_DIR}/proto
         --plugin=protoc-gen-grpc=${GRPC_CPP_PLUGIN_LOCATION}
         ${CMAKE_CURRENT_SOURCE_DIR}/proto/texas_holdem.proto
    DEPENDS ${PROTO_FILES}
    COMMENT "Generating gRPC C++ files from texas_holdem.proto"
)

# Create a custom target for the gRPC generated files
add_custom_target(grpc_generated_files
    DEPENDS ${CMAKE_CURRENT_BINARY_DIR}/texas_holdem.grpc.pb.cc
            ${CMAKE_CURRENT_BINARY_DIR}/texas_holdem.grpc.pb.h
)

# Include the generated files
set(GRPC_SRC ${CMAKE_CURRENT_BINARY_DIR}/texas_holdem.grpc.pb.cc)
set(GRPC_HDR ${CMAKE_CURRENT_BINARY_DIR}/texas_holdem.grpc.pb.h)

# Create a library for Protobuf and gRPC
add_library(proto
    ${PROTO_SRC}
    ${PROTO_HDR}
    ${GRPC_SRC}
    ${GRPC_HDR}
)

# Ensure proto library depends on gRPC generated files
add_dependencies(proto grpc_generated_files)

# Link necessary libraries to the proto library
target_link_libraries(proto
    PUBLIC
        protobuf::libprotobuf
        gRPC::grpc++
)

# Gather all your source files
file(GLOB SRC_FILES
    server/src/Entities/*.cpp
    server/src/Shared/*.cpp
    server/src/Services/*.cpp
    server/src/States/*.cpp
    server/src/Utils/*.cpp
    server/src/*.cpp
)

# Create the main library and include the generated proto sources
add_library(HoldEmLibrary
    ${SRC_FILES}
    ${PROTO_SRC}
    ${PROTO_HDR}
    ${GRPC_SRC}
    ${GRPC_HDR}
)

# Link libraries to HoldEmLibrary
target_link_libraries(HoldEmLibrary
    PRIVATE
        Boost::random
        proto
)

# Enable testing
enable_testing()

# Include GTest directories
include_directories(${GTEST_INCLUDE_DIRS})

# Define a function to add tests
function(addTest TEST_NAME TEST_FILE)
    add_executable(${TEST_NAME} ${TEST_FILE})
    target_link_libraries(${TEST_NAME}
        PRIVATE
            HoldEmLibrary
            GTest::GTest
            GTest::Main
            Threads::Threads
    )
    add_test(NAME ${TEST_NAME} COMMAND ${TEST_NAME})
endfunction()

# List of test files
set(TEST_FILES
    PlayerTest
    PositionTest
    DealerTest
    HandRankTest
    ActionTest
    PotManagerTest
    IOTest
)

# Add each test
foreach(TEST_NAME IN LISTS TEST_FILES)
    addTest(${TEST_NAME} server/test/Services/${TEST_NAME}.cpp)
endforeach()

# Create the main executable
add_executable(PokerMain server/main.cpp)
target_link_libraries(PokerMain PRIVATE HoldEmLibrary)

# Custom target to run the main executable
add_custom_target(run
    COMMAND PokerMain
    WORKING_DIRECTORY ${CMAKE_BINARY_DIR}
)

# Custom target to run tests
add_custom_target(run_tests
    COMMAND ctest --output-on-failure
    WORKING_DIRECTORY ${CMAKE_BINARY_DIR}
    COMMENT "Running Tests"
)
